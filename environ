#!bash

[ "$DEBUG" ] && echo "++ environ [self=$0]"

joins() { var=$1; shift; eval "$var=\$*"; unset var; }

setpath() {
	# real sh does not allow unsetting IFS,
	# and `foo=bar join` does not always work
	set +a; xIFS=$IFS; IFS=":";    set -a
	joins "$@"
	set +a; IFS=$xIFS; unset xIFS; set -a
}

# basic environ

umask 022

set -a

[ "$USER" ]     || USER=`id -un`
[ "$UID" ]      || UID=`id -u`
[ "$HOSTNAME" ] || HOSTNAME=`hostname`

# session info

if [ -z "$DESKTOP_SESSION" ] && [ "$OS" = "Windows_NT" ]; then
	DESKTOP_SESSION=$OS
fi

# paths/locations

PREFIX="$HOME/.local"

setpath PATH \
	"$HOME/.rbenv/shims"		\
	"$HOME/bin"			\
	"$HOME/code/obj/host.$HOSTNAME"	\
	"$HOME/code/bin"		\
	"$HOME/.rbenv/bin"		\
	"$HOME/.cabal/bin"		\
	"$PREFIX/bin"			\
	"/usr/lib/ccache/bin"		\
	"/usr/lib/ccache"		\
	"$PATH"				\
	"/usr/local/sbin" 		\
	"/usr/sbin"			\
	"/sbin"				\
	"/opt/csw/bin"			\
	"$HOME/code/bin/fbin"		;

setpath PYTHONPATH \
	"$PREFIX/lib/python"		\
	"$HOME/code/lib/python"		;

setpath PERL5LIB \
	"$PREFIX/lib/perl5"		\
	"$HOME/code/lib/perl5"		;

GNULIB_SRCDIR="$HOME/src/gnu/gnulib"

test "$XDG_CACHE_HOME"  || XDG_CACHE_HOME="$HOME/.cache"
test "$XDG_CONFIG_HOME" || XDG_CONFIG_HOME="$HOME/.config"

# identity

NAME='Mantas MikulÄ—nas'
EMAIL="grawity@nullroute.eu.org"
TZ="Europe/Vilnius"

# preferred programs

BROWSER="web-browser"
EDITOR="vim"
unset VISUAL
PAGER="less"

# libdefaults

GTK_IM_MODULE="xim"
HOSTALIASES="$HOME/lib/dotfiles/hostaliases"
_JAVA_OPTIONS="-Dawt.useSystemAAFontSettings=on"
NCURSES_NO_UTF8_ACS="1"
QT_IM_MODULE="xim"

# appdefaults

ABSROOT="$HOME/pkg"
ACK_PAGER="$PAGER"
GNUSTEP_USER_ROOT="$XDG_CONFIG_HOME/GNUstep"
LESS="e M q R F X z -3"
LESSHISTFILE="$XDG_CACHE_HOME/less.history"
MAKEFLAGS="-j $(nproc)"
MYSQL_HISTFILE="$XDG_CACHE_HOME/mysql.history"
PYTHONSTARTUP="$HOME/lib/dotfiles/pythonrc"
OPERA_PERSONALDIR="$XDG_CONFIG_HOME/opera"

# local

if [ -f ~/lib/dotfiles/environ-$HOSTNAME ]; then
	. ~/lib/dotfiles/environ-$HOSTNAME
elif [ -f ~/.environ-$HOSTNAME ]; then
	. ~/.environ-$HOSTNAME
fi

# appdefaults - local

if [ "$LOCAL_PERL" = n ]; then
	PERL_CPANM_OPT="--sudo"
else
	PERL_MM_OPT="INSTALL_BASE='$PREFIX'"
	PERL_MB_OPT="--install_base '$PREFIX'"
fi

# disable allexport

set +a
