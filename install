#!/usr/bin/env bash
set -e

have() { command -v "$@" >/dev/null; }

link() {
	local target="$dir/${1%/}" link=$2
	if [ -e "$link" ]; then
		if [ -h "$link" ]; then
			rm -f "$link"
		else
			trash "$link"
		fi
	fi
	sym -f "$target" "$link"
}

sym() { ~/code/bin/sym "$@"; }

trash() {
	local file
	for file; do
		[ -e "$file" ] || continue
		[ -d "$trash" ] || mkdir -pm 0700 "$trash"
		echo "Backing up ${file/#$HOME/~} to ${trash/#$HOME/~}"
		mv "$file" "$trash"
	done
}

dir=$(dirname "$0")
trash=~/trash
all=false

while getopts 'a' OPT; do
	case $OPT in
	'a')	all=true;;
	'?')	echo "Usage: install [-a]"; exit 2;;
	esac
done

mkdir -pm 0700 ~/.ssh
link bashrc	~/.bashrc
link gitconfig	~/.gitconfig
link gitignore	~/.gitignore
link inputrc	~/.inputrc
link profile	~/.profile
link vimrc	~/.vimrc
link vim/	~/.vim

if [[ -e ~/.ssh/config-$HOSTNAME.gen ]]; then
	./ssh-config.gen -f
else
	link ssh-config ~/.ssh/config
fi

have gvim &&
	link gvimrc	~/.gvimrc

have makepkg &&
	link makepkg.conf	~/.makepkg.conf

trash	~/.bash_{login,profile,logout}

$all || exit 0

have irb &&
	link irbrc	~/.irbrc
have mail &&
	link mailrc		~/.mailrc
have msmtp && {
	link msmtprc		~/.msmtprc
	chmod 600 ~/.msmtprc
}
have mutt && {
	#link muttrc		~/.muttrc
	[[ -f ~/.muttrc ]] ||
		echo 'source "~/lib/dotfiles/muttrc"' > ~/.muttrc
}
have screen &&
	link screenrc	~/.screenrc
have tmux &&
	link tmux.conf	~/.tmux.conf
have xrdb && {
	link Xresources	~/.Xresources
	link XCompose	~/.XCompose
	link fonts.conf	~/.fonts.conf
}

link k5identity	~/.k5identity

exit 0
