#!/usr/bin/env bash

PATH=$HOME/code/bin:$PATH

. lib.bash || exit

progname='dotfiles/install'

trash() {
	local file
	for file; do
		if [ ! -e "$file" ]; then
			continue
		elif [ -k "$file" ]; then
			trace "ignoring sticky $file"
			continue
		else
			local hash=$(sha1sum "$file" | awk '{print $1}')
			if case $hash in
				# Debian ~/.profile
				79d58526d0e0bf4df4f01b383ed3f49c428aaa2a) true;;
				# Debian ~/.bash_logout
				dc216ac4a4c232815731979db6e494f315b507dd) true;;
				*) false;;
			esac; then
				rm -f "$file"
				continue
			fi
			if [ ! -d "$trash" ]; then
				mkdir -pm 0700 "$trash"
			fi
			echo "backing up $file -> $trash"
			mv "$file" "$trash/old_${file##*/}"
		fi
	done
}

link() {
	local target=$dir/${1%/} link=${2:-$HOME/.$1}
	if [ ! -e "$target" ]; then
		err "link target is missing: $link -> $target"
		return
	elif [ -e "$link" ]; then
		if [ -k "$link" ]; then
			trace "ignoring sticky $link"
			return
		elif [ -h "$link" ]; then
			rm -f "$link"
		else
			trash "$link"
		fi
	else
		local linkdir=${link%/*}
		if [ ! -d "$linkdir" ]; then
			mkdir -p "$linkdir"
		fi
	fi
	trace "linking $link -> $target"
	sym -f "$target" "$link"
}

if [[ -t 0 ]]; then
	VERBOSE=1
fi

dir=$(dirname "$(sym -R "$0")")
trash=~/tmp

cd "$dir"

trash ~/.{login,logout}
trash ~/.bash_{login,profile,logout}
trash ~/.{sh,csh}rc
rm -f ~/.viminfo

link bashrc
link htoprc
link inputrc
link profile
link git ~/.config/git
link vim

if [ -h ~/.gitconfig ] || ! git config --global github.user >/dev/null 2>&1; then
	link git/config ~/.gitconfig
fi

if [ -h ~/.gitignore ]; then
	link git/ignore ~/.gitignore
fi

if have msmtp; then
	link mail/msmtprc ~/.msmtprc
	chmod 600 ~/.msmtprc
fi

if have ssh; then
	trace "updating $HOME/.ssh/config"
	ssh/generate
	link ssh/known_hosts
fi

if have tmux; then
	link tmux.conf
fi

if [ "$DISPLAY" ]; then
	link gui/XCompose ~/.XCompose

	if have fc-cache; then
		link gui/fonts.conf.xml ~/.config/fontconfig/fonts.conf
	fi

	if have openbox; then
		link gui/openbox-rc.xml ~/.config/openbox/rc.xml
		link gui/openbox-autostart ~/.config/openbox/autostart
	fi

	if [ ! -f "$XDG_CONFIG_HOME/user-dirs.dirs" ]; then
		cp gui/user-dirs.dirs "$XDG_CONFIG_HOME/user-dirs.dirs"
	fi
fi

exit 0
