#!/usr/bin/env bash
set -e

link() {
	local target="$dir/${1%/}" link=$2
	if [ -e "$link" ]; then
		if [ -h "$link" ]; then
			rm -f "$link"
		else
			trash "$link"
		fi
	fi
	sym -f "$target" "$link"
}

sym() { ~/code/sym.pl "$@"; }

trash() {
	for file; do
		[ -e "$file" ] || continue
		[ -d "$trash" ] || mkdir -pm 0700 "$trash"
		echo "Backing up ${file/#$HOME/~} to ${trash/#$HOME/~}"
		mv "$file" "$trash"
	done
}

dir=~/lib/dotfiles
trash=~/trash
all=false

while getopts ad: OPT; do
	case $OPT in
	a)	all=true;;
	d)	dir=$OPTARG;;
	esac
done

mkdir -pm 0700 ~/.ssh
link	bashrc		~/.bashrc
link	gitconfig	~/.gitconfig
link	gitignore	~/.gitignore
link	inputrc		~/.inputrc
link	profile		~/.profile
link	ssh-config	~/.ssh/config
link	vimrc		~/.vimrc
link	vim/		~/.vim

trash	~/.bash_{login,profile,logout}

$all || exit 0

link	mailrc		~/.mailrc
link	muttrc		~/.muttrc
link	screenrc	~/.screenrc
link	tmux.conf	~/.tmux.conf
