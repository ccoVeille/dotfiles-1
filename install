#!/usr/bin/env bash
set -e

have() { command -v "$@" >/dev/null; }

link() {
	local target="$dir/${1%/}" link=$2
	if [ -e "$link" ]; then
		if [ -h "$link" ]; then
			rm -f "$link"
		else
			trash "$link"
		fi
	fi
	sym -f "$target" "$link"
}

sym() { ~/code/bin/sym "$@"; }

trash() {
	local file
	for file; do
		[ -e "$file" ] || continue
		[ -d "$trash" ] || mkdir -pm 0700 "$trash"
		echo "Backing up ${file/#$HOME/~} to ${trash/#$HOME/~}"
		mv "$file" "$trash"
	done
}

dir=~/lib/dotfiles
trash=~/trash
all=false

while getopts ad: OPT; do
	case $OPT in
	a)	all=true;;
	d)	dir=$OPTARG;;
	esac
done

mkdir -pm 0700 ~/.ssh
link	bashrc		~/.bashrc
link	gitconfig	~/.gitconfig
link	gitignore	~/.gitignore
link	inputrc		~/.inputrc
link	profile		~/.profile
link	ssh-config	~/.ssh/config
link	vimrc		~/.vimrc
link	vim/		~/.vim

trash	~/.bash_{login,profile,logout}

$all || exit 0

have mail &&
	: link	mailrc		~/.mailrc
have makepkg &&
	link	makepkg.conf	~/.makepkg.conf
have msmtp && {
	link	msmtprc		~/.msmtprc
	chmod 600 ~/.msmtprc
}
have mutt && {
	: link	muttrc		~/.muttrc
	[[ -f ~/.muttrc ]] ||
		echo 'source "~/lib/dotfiles/muttrc"' > ~/.muttrc
}
have screen &&
	link	screenrc	~/.screenrc
have tmux &&
	link	tmux.conf	~/.tmux.conf
have xrdb &&
	link	Xresources	~/.Xresources
