#!sh

: ${XDG_CONFIG_HOME:=~/.config}

[ -f "$XDG_CONFIG_HOME/Xresources" ] \
	&& xrdb -merge "$XDG_CONFIG_HOME/Xresources"
[ -f "$XDG_CONFIG_HOME/Xkbmap" ] \
	&& setxkbmap `cat "$XDG_CONFIG_HOME/Xkbmap"`
[ -f "$XDG_CONFIG_HOME/Xmodmap" ] \
	&& xmodmap "$XDG_CONFIG_HOME/Xmodmap"

xhost +"SI:localuser:$USER" &

if have keyctl; then
	# set up session keyring (pam_keyinit does not work with GDM due to
	# thread issues, fixed in Linux commit 3a50597de)
	if [ "`keyctl rdescribe @s`" = "`keyctl rdescribe @us`" ]; then
		keyctl show -x
		echo "Creating new session keyring"
		if keyctl new_session > /dev/null; then
			keyctl link @u @s
			keyctl show -x
		fi
	else
		echo "Session keyring is already okay"
		keyctl show -x
	fi
	# set up some pointers to environment (for use by cron)
	if have globalenv; then
		globalenv -s \
			+DBUS_SESSION_BUS_ADDRESS	\
			+DISPLAY			\
			+KRB5CCNAME			\
			+SSH_AUTH_SOCK			\
			+XAUTHORITY			\
			+XDG_RUNTIME_DIR		\
			;
	fi
fi

if have auca-seed; then
	auca-seed &
fi

if [ -f ~/.config/synclient.conf ]; then
	synclient `grep -v "^#" ~/.config/synclient.conf` &
fi

if [ ! "$DESKTOP_SESSION" ]; then
	#if [ ! "$DBUS_SESSION_BUS_ADDRESS" ]; then
	#	eval $(dbus-launch --sh-syntax --exit-with-session)
	#fi

	compton &

	/usr/lib/notify-osd/notify-osd &

	/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &

	gnome-screensaver &

	systemd-lock-handler gnome-screensaver-command --lock &

	xbindkeys -f ~/.config/xbindkeys/xbindkeysrc &
fi

if [ $HOSTNAME = rain ]; then
	gnome-mpris-inhibit mpd --flags=suspend &

	mpris mpd notify-idle &
fi

true
